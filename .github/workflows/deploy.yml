name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  tailscale-acl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ./version-cache.json
          key: version-cache.json-${{ github.run_id }}
          restore-keys: version-cache.json-

      - name: Test ACL
        if: github.event_name == 'pull_request'
        uses: tailscale/gitops-acl-action@v1
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tailnet: ${{ secrets.TS_TAILNET }}
          action: test

      - name: Apply ACL
        if: github.event_name == 'push'
        uses: tailscale/gitops-acl-action@v1
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tailnet: ${{ secrets.TS_TAILNET }}
          action: apply

  wait-for-garnix:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Wait for Garnix checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Waiting for Garnix checks to complete..."
          for i in {1..60}; do
            # Get all check runs for this commit
            result=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs \
              --jq '{
                total: .total_count,
                garnix: [.check_runs[] | select(.app.slug == "garnix-ci")],
                pending: [.check_runs[] | select(.app.slug == "garnix-ci" and .status != "completed")] | length,
                failed: [.check_runs[] | select(.app.slug == "garnix-ci" and .status == "completed" and .conclusion != "success")] | length
              }')

            total=$(echo "$result" | jq -r '.garnix | length')
            pending=$(echo "$result" | jq -r '.pending')
            failed=$(echo "$result" | jq -r '.failed')

            echo "Attempt $i: $total Garnix checks, $pending pending, $failed failed"

            if [ "$total" -gt 0 ] && [ "$pending" -eq 0 ]; then
              if [ "$failed" -eq 0 ]; then
                echo "All Garnix checks passed!"
                exit 0
              else
                echo "Garnix checks failed!"
                exit 1
              fi
            fi
            sleep 30
          done
          echo "Timeout waiting for Garnix checks"
          exit 1

  deploy:
    runs-on: ubuntu-latest
    needs: [tailscale-acl, wait-for-garnix]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:deploy

      - name: Add SSH host keys
        run: |
          mkdir -p ~/.ssh
          echo "endeavour ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAJxgao1yX2VxxPIozAKlL3cbk2SpBPfxjF29q7S/oFf" >> ~/.ssh/known_hosts
          echo "enterprise ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFQt03m35by3UEWbU2KiEsr+9jnxXoFwRNflQYKCjE6n" >> ~/.ssh/known_hosts
          echo "stargazer ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIK1jqNdM9sPcuX9qkMPvlTMnkzyUQY1CnMGYHv2Epogo" >> ~/.ssh/known_hosts

      - name: Deploy
        run: nix run github:serokell/deploy-rs -- --skip-checks --remote-build
